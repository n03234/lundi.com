{% extends 'layout.html' %}
{% block content %}
  <h2>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</h2>
  <form action="/search" method="get" class="search-form" style="margin-bottom:12px">
    <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <input name="q" value="{{ q or '' }}" placeholder="ä¾‹: ãƒ©ãƒ¼ãƒ¡ãƒ³, ã‚«ãƒ¬ãƒ¼"></label>
    <label>ç¨®åˆ¥:
      <select name="t">
        <option value="all" {% if (t or 'all')=='all' %}selected{% endif %}>å…¨æŠ•ç¨¿</option>
        <option value="shop" {% if t=='shop' %}selected{% endif %}>åº—å/ãŠåº—ç´¹ä»‹</option>
        <option value="recipe" {% if t=='recipe' %}selected{% endif %}>ãƒ¬ã‚·ãƒ”ç´¹ä»‹</option>
      </select>
    </label>
    <button type="submit">æ¤œç´¢</button>
  </form>
  <h2>ä½æ‰€ã‹ã‚‰åº—èˆ—æ¤œç´¢</h2>
  <form action="/search" method="get" class="search-form">
    <label>ä½æ‰€: <input name="address" value="{{ address or '' }}" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº"></label>
    <label>åŠå¾„(km): <input name="r" value="{{ radius_km or 2 }}" type="number" step="0.1" min="0.1" max="50"></label>
    <button type="submit">æ¤œç´¢</button>
  </form>
  <div style="margin:8px 0 16px">
    <button type="button" id="nearMeBtn">ç¾åœ¨åœ°ä»˜è¿‘ï¼ˆåº—èˆ—ï¼‰</button>
  </div>
  <script>
    (function(){
      const btn = document.getElementById('nearMeBtn');
      if (btn && navigator.geolocation) {
        btn.addEventListener('click', function(){
          navigator.geolocation.getCurrentPosition(function(pos){
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const r = 2; // km
            location.href = `/near?lat=${lat}&lng=${lng}&r=${r}`;
          }, function(err){ console.log('geo error', err); }, {enableHighAccuracy:true, timeout:5000});
        });
      }
    })();
  </script>
  {% if lat and lng %}
    <p>æ¤œç´¢ä½ç½®: ({{ lat }}, {{ lng }})</p>
  {% endif %}
  <section class="feed">
    {% for p in posts %}
      <article class="post">
        <div class="post-header">
          {% if p['avatar'] %}
            <img class="avatar-img" src="{{ url_for('static', filename='uploads/avatars/' ~ p['avatar']) }}" alt="avatar">
          {% else %}
            <div class="avatar">{{ p['username'][:1]|upper }}</div>
          {% endif %}
          <div>
            <div><a href="/user/{{ p['username'] }}">{{ p['username'] }}</a>
              <span class="badge">{% if p['category']=='food_photo' %}ã”é£¯ã®å†™çœŸ{% elif p['category']=='shop_intro' %}ãŠåº—ã®ç´¹ä»‹{% elif p['category']=='recipe_intro' %}ãƒ¬ã‚·ãƒ”ç´¹ä»‹{% else %}ãã®ä»–{% endif %}</span>
              {% if p['distance_km'] is defined %}<span class="badge">ç´„ {{ p['distance_km'] }} km</span>{% endif %}
            </div>
            <div class="meta">{{ p['created_at'] }}</div>
          </div>
        </div>
        <p class="content">{{ p['content'] }}</p>
        {% if p['image'] %}
          {% set thumb_path = 'uploads/thumbs/thumb_' + p['image'] %}
          {% set full_path = 'uploads/' + p['image'] %}
          <div class="post-image"><a href="{{ url_for('static', filename=full_path) }}" target="_blank"><img src="{{ url_for('static', filename=thumb_path) }}" alt="image" style="max-width:320px"></a></div>
        {% endif %}
        {% if p['category']=='shop_intro' and p['shop_category'] %}
          <div class="subcat">ã‚«ãƒ†ã‚´ãƒª: {{ p['shop_category'] }}</div>
          <ul class="shop-detail-list">
            {% if p['shop_name'] %}<li>åº—å: {{ p['shop_name'] }}</li>{% endif %}
            {% if p['shop_address'] %}<li>ä½æ‰€: {{ p['shop_address'] }}</li>{% endif %}
            {% if p['shop_url'] %}<li>URL: <a href="{{ p['shop_url'] }}" target="_blank" rel="noopener">{{ p['shop_url'] }}</a></li>{% endif %}
            {% if p['shop_hours'] %}<li>å–¶æ¥­æ™‚é–“: {{ p['shop_hours'] }}</li>{% endif %}
            {% if p['shop_phone'] %}<li>é›»è©±ç•ªå·: {{ p['shop_phone'] }}</li>{% endif %}
            {% if p['shop_price_range'] %}<li>ä¾¡æ ¼å¸¯: {{ p['shop_price_range'] }}</li>{% endif %}
            {% if p['shop_lat'] and p['shop_lng'] %}
              <li>ä½ç½®æƒ…å ±: <a href="https://www.google.com/maps?q={{ p['shop_lat'] }},{{ p['shop_lng'] }}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§é–‹ã</a></li>
            {% endif %}
          </ul>
        {% endif %}
        <div class="post-actions">
          {% if user %}
          <form action="/bookmark/{{ p['id'] }}" method="post" class="bm-form" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if bookmarked_ids and (p['id'] in bookmarked_ids) %}
              <button type="submit">ğŸ”– è§£é™¤</button>
            {% else %}
              <button type="submit">ğŸ”– è¿½åŠ </button>
            {% endif %}
          </form>
          {% endif %}
        </div>
      </article>
    {% else %}
      <p>è©²å½“ã™ã‚‹æŠ•ç¨¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
    {% endfor %}
  </section>
{% endblock %}
