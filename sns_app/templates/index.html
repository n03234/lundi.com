{% extends 'layout.html' %}
{% block content %}
  <section class="post-box">
    {% if user %}
      <form action="/post" method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>ã‚«ãƒ†ã‚´ãƒª:
          <select name="category" required>
            <option value="food_photo">ã”é£¯ã®å†™çœŸ</option>
            <option value="shop_intro">ãŠåº—ã®ç´¹ä»‹</option>
            <option value="recipe_intro">ãƒ¬ã‚·ãƒ”ç´¹ä»‹</option>
          </select>
        </label>
        <label class="shop-only">åº—èˆ—ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼ˆåº—èˆ—ç´¹ä»‹æ™‚ã®ã¿ï¼‰:
          <select name="shop_category">
            <option value="">-- é¸æŠ --</option>
            <option>å’Œé£Ÿ</option>
            <option>æ´‹é£Ÿ</option>
            <option>ä¸­è¯</option>
            <option>ã‚«ãƒ•ã‚§</option>
            <option>å±…é…’å±‹</option>
            <option>ãƒ©ãƒ¼ãƒ¡ãƒ³</option>
            <option>ã‚¹ã‚¤ãƒ¼ãƒ„</option>
          </select>
        </label>
        <fieldset class="shop-details shop-only">
          <legend>åº—èˆ—è©³ç´°ï¼ˆåº—èˆ—ç´¹ä»‹æ™‚ã®ã¿ï¼‰</legend>
          <label>åº—å: <input name="shop_name" maxlength="200"></label>
          <label>ä½æ‰€: <input name="shop_address" maxlength="200"></label>
          <label>URL: <input name="shop_url" maxlength="300" placeholder="https://..."></label>
          <label>å–¶æ¥­æ™‚é–“: <input name="shop_hours" maxlength="200" placeholder="ä¾‹: 11:00-22:00"></label>
          <label>é›»è©±ç•ªå·: <input name="shop_phone" maxlength="200"></label>
          <label>ä¾¡æ ¼å¸¯: <input name="shop_price_range" maxlength="200" placeholder="ä¾‹: 1000-2000å††"></label>
          <input type="hidden" name="shop_lat" id="shop_lat">
          <input type="hidden" name="shop_lng" id="shop_lng">
        </fieldset>

        <script>
          (function() {
            const catSel = document.querySelector('select[name="category"]');
            const nameInput = document.querySelector('input[name="shop_name"]');
            const addrInput = document.querySelector('input[name="shop_address"]');
            const latInput = document.getElementById('shop_lat');
            const lngInput = document.getElementById('shop_lng');
            const shopOnlyElems = document.querySelectorAll('.shop-only');
            function toggleShopOnly(){
              const show = catSel && catSel.value === 'shop_intro';
              shopOnlyElems.forEach(el => { el.style.display = show ? '' : 'none'; });
            }
            function updateGeo() {
              if (catSel.value === 'shop_intro' && navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                  const lat = pos.coords.latitude;
                  const lng = pos.coords.longitude;
                  if (latInput && lngInput) {
                    latInput.value = lat;
                    lngInput.value = lng;
                  }
                }, function(err){
                  console.log('geolocation error', err);
                }, {enableHighAccuracy: true, timeout: 5000});
              }
            }
            async function geocodeByName() {
              if (catSel.value !== 'shop_intro') return;
              const name = nameInput && nameInput.value.trim();
              const address = addrInput && addrInput.value.trim();
              if (!name && !address) return;
              try {
                const params = new URLSearchParams();
                if (name) params.append('name', name);
                if (address) params.append('address', address);
                const res = await fetch('/geocode?' + params.toString());
                if (res.ok) {
                  const j = await res.json();
                  if (j.lat && j.lng) {
                    latInput.value = j.lat;
                    lngInput.value = j.lng;
                  }
                }
              } catch (e) {
                console.log('geocode error', e);
              }
            }
            if (catSel) {
              catSel.addEventListener('change', function(){ updateGeo(); toggleShopOnly(); });
              // initial
              updateGeo();
              toggleShopOnly();
            }
            if (nameInput) {
              nameInput.addEventListener('blur', geocodeByName);
              nameInput.addEventListener('change', geocodeByName);
            }
            if (addrInput) {
              addrInput.addEventListener('blur', geocodeByName);
              addrInput.addEventListener('change', geocodeByName);
            }
          })();
        </script>
        <textarea name="content" rows="3" placeholder="ã„ã¾ã©ã†ã—ã¦ã‚‹ï¼Ÿ"></textarea>
        <div>
          <input type="file" name="image" accept="image/*">
        </div>
        <div><button type="submit">æŠ•ç¨¿</button></div>
      </form>
    {% else %}
      <p><a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦æŠ•ç¨¿ã§ãã¾ã™ã€‚</p>
    {% endif %}
  </section>

  <section class="feed">
    {% for p in posts %}
      <article class="post">
        <div class="post-header">
          {% if p['avatar'] %}
            <img class="avatar-img" src="{{ url_for('static', filename='uploads/avatars/' ~ p['avatar']) }}" alt="avatar">
          {% else %}
            <div class="avatar">{{ p['username'][:1]|upper }}</div>
          {% endif %}
          <div>
            <div><a href="/user/{{ p['username'] }}">{{ p['username'] }}</a> <span class="badge">{% if p['category']=='food_photo' %}ã”é£¯ã®å†™çœŸ{% elif p['category']=='shop_intro' %}ãŠåº—ã®ç´¹ä»‹{% elif p['category']=='recipe_intro' %}ãƒ¬ã‚·ãƒ”ç´¹ä»‹{% else %}ãã®ä»–{% endif %}</span></div>
            <div class="meta">{{ p['created_at'] }}</div>
          </div>
        </div>
        <p class="content">{{ p['content'] }}</p>
        {% if p['image'] %}
          {% set thumb_path = 'uploads/thumbs/thumb_' + p['image'] %}
          {% set full_path = 'uploads/' + p['image'] %}
          <div class="post-image"><a href="{{ url_for('static', filename=full_path) }}" target="_blank"><img src="{{ url_for('static', filename=thumb_path) }}" alt="image" style="max-width:320px"></a></div>
        {% endif %}
        {% if p['category']=='shop_intro' and p['shop_category'] %}
          <div class="subcat">ã‚«ãƒ†ã‚´ãƒª: {{ p['shop_category'] }}</div>
          <ul class="shop-detail-list">
            {% if p['shop_name'] %}<li>åº—å: {{ p['shop_name'] }}</li>{% endif %}
            {% if p['shop_address'] %}<li>ä½æ‰€: {{ p['shop_address'] }}</li>{% endif %}
            {% if p['shop_url'] %}<li>URL: <a href="{{ p['shop_url'] }}" target="_blank" rel="noopener">{{ p['shop_url'] }}</a></li>{% endif %}
            {% if p['shop_hours'] %}<li>å–¶æ¥­æ™‚é–“: {{ p['shop_hours'] }}</li>{% endif %}
            {% if p['shop_phone'] %}<li>é›»è©±ç•ªå·: {{ p['shop_phone'] }}</li>{% endif %}
            {% if p['shop_price_range'] %}<li>ä¾¡æ ¼å¸¯: {{ p['shop_price_range'] }}</li>{% endif %}
            {% if p['shop_lat'] and p['shop_lng'] %}
              <li>ä½ç½®æƒ…å ±: <a href="https://www.google.com/maps?q={{ p['shop_lat'] }},{{ p['shop_lng'] }}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§é–‹ã</a></li>
            {% endif %}
          </ul>
        {% endif %}
        <div class="post-actions">
          <form action="/like/{{ p['id'] }}" method="post" class="like-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit">ã„ã„ã­ ({{ p['likes'] }})</button>
          </form>
          {% if user %}
          <form action="/bookmark/{{ p['id'] }}" method="post" class="bm-form" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            {% if p['id'] in bookmarked_ids %}
              <button type="submit">ğŸ”– è§£é™¤</button>
            {% else %}
              <button type="submit">ğŸ”– è¿½åŠ </button>
            {% endif %}
          </form>
          {% endif %}
          {% if user and user.id == p['user_id'] %}
            <a href="/edit/{{ p['id'] }}">ç·¨é›†</a>
            <form action="/delete/{{ p['id'] }}" method="post" style="display:inline" onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit">å‰Šé™¤</button>
            </form>
          {% endif %}
        </div>
      </article>
    {% else %}
      <p>ã¾ã æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}
  </section>

  <nav class="pagination">
    {% if page > 1 %}
      <a href="?page={{ page-1 }}{% if q %}&q={{ q }}{% endif %}">å‰ã¸</a>
    {% endif %}
    <span>ãƒšãƒ¼ã‚¸ {{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="?page={{ page+1 }}{% if q %}&q={{ q }}{% endif %}">æ¬¡ã¸</a>
    {% endif %}
  </nav>
{% endblock %}
